<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Log PWA</title>
    <meta name="description" content="Track strength and bike workouts with progress charts.">
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-180x180.png">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f8f8; touch-action: manipulation; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e0e0e0; }
        input, select { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
        button { padding: 12px; background-color: #4CAF50; color: white; border: none; cursor: pointer; font-size: 16px; width: 100%; margin: 10px 0; }
        button:hover { background-color: #45a049; }
        .alert { color: #d32f2f; font-weight: bold; }
        .suggestion { color: #388e3c; }
        .chart-container { margin: 20px 0; max-width: 100%; width: 100%; }
        .session-details { margin: 15px 0; padding: 10px; background-color: #e8f5e9; border-radius: 5px; }
        h1 { font-size: 24px; }
        h2, h3 { color: #333; font-size: 20px; }
        @media (max-width: 600px) { th, td { font-size: 14px; padding: 6px; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        // Fallback if primary CDN fails
        if (typeof Chart === "undefined") {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js"><\/script>');
        }
    </script>
</head>
<body>
    <h1>Workout Log</h1>
    <h2>Day <span id="dayDisplay">1</span> - <span id="sessionType">Strength</span></h2>
    <button onclick="toggleDay()">Switch to Day <span id="dayToggle">2</span></button>
    <form id="workoutForm">
        <table id="exerciseTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="sessionDetails" class="session-details"></div>
        <button type="submit">Save Session</button>
    </form>
    <h2>Progress History</h2>
    <table id="historyTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Exercise</th>
                <th>Sets</th>
                <th>Reps/Duration (min)</th>
                <th>Weight (kg)/Type</th>
                <th>Pain/RPE (0-10)</th>
                <th>Suggestion</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    <h2>Progress Charts</h2>
    <div id="chartsContainer"></div>

    <script>
        const days = [
            {
                name: "day1",
                type: "strength",
                label: "Day 1 - Strength",
                exercises: [
                    { name: "Barbell Back Squat", type: "barbell", sets: 3, minReps: 8, maxReps: 12, weight: 30 },
                    { name: "Barbell Bench Press", type: "barbell", sets: 3, minReps: 8, maxReps: 12, weight: 45 },
                    { name: "Pull-Ups", type: "bodyweight", sets: 3, minReps: 8, maxReps: 12, weight: 0 },
                    { name: "Dumbbell Overhead Press", type: "dumbbell", sets: 3, minReps: 10, maxReps: 12, weight: 10 },
                    { name: "Cable Face Pulls", type: "cable", sets: 3, minReps: 12, maxReps: 15, weight: 10 },
                    { name: "Elbow to Knee Plank", type: "core", sets: 3, minReps: 30, maxReps: 45, weight: 0, unit: "seconds" }
                ]
            },
            {
                name: "day2",
                type: "bike",
                label: "Day 2 - Bike HIIT",
                exercises: [
                    { name: "Bike HIIT", type: "bike", sets: 1, minDuration: 20, maxDuration: 25, sessionType: "HIIT" }
                ],
                details: "HIIT: 8 rounds of 30s sprint (max effort, high resistance) + 90s recovery (low resistance, easy pedaling). Target heart rate: 80–90% max (~144–171 bpm for age 30–40; calculate 220 – your age for max). Use upright posture to minimize back strain."
            },
            {
                name: "day3",
                type: "strength",
                label: "Day 3 - Strength",
                exercises: [
                    { name: "Barbell Deadlift", type: "barbell", sets: 3, minReps: 8, maxReps: 10, weight: 50 },
                    { name: "Dips", type: "bodyweight", sets: 3, minReps: 8, maxReps: 12, weight: 0 },
                    { name: "Single-Arm Cable Pulldown", type: "cable", sets: 3, minReps: 10, maxReps: 12, weight: 10 },
                    { name: "Dumbbell Goblet Squat", type: "dumbbell", sets: 3, minReps: 10, maxReps: 12, weight: 15 },
                    { name: "Cable Tricep Pushdowns", type: "cable", sets: 3, minReps: 12, maxReps: 15, weight: 10 },
                    { name: "Pallof Press", type: "core", sets: 3, minReps: 12, maxReps: 15, weight: 5 }
                ]
            },
            {
                name: "day4",
                type: "bike",
                label: "Day 4 - Bike Steady-State",
                exercises: [
                    { name: "Bike Steady-State", type: "bike", sets: 1, minDuration: 40, maxDuration: 50, sessionType: "Steady-State" }
                ],
                details: "Steady-State: 40–50 min at consistent pace (moderate resistance, comfortable pedaling). Target heart rate: 60–70% max (~108–133 bpm for age 30–40; calculate 220 – your age). Keep upright posture, avoid leaning forward to reduce back strain."
            },
            {
                name: "day5",
                type: "bike",
                label: "Day 5 - Bike",
                exercises: [
                    { name: "Bike Session", type: "bike", sets: 1, minDuration: 20, maxDuration: 50, sessionType: "Select" }
                ],
                details: {
                    HIIT: "HIIT: 8 rounds of 30s sprint (max effort, high resistance) + 90s recovery (low resistance, easy pedaling). Target heart rate: 80–90% max (~144–171 bpm for age 30–40; calculate 220 – your age). Use upright posture to minimize back strain.",
                    "Steady-State": "Steady-State: 20–50 min at consistent pace (moderate resistance, comfortable pedaling). Target heart rate: 60–70% max (~108–133 bpm for age 30–40; calculate 220 – your age). Keep upright posture, avoid leaning forward."
                }
            }
        ];

        let currentDayIndex = 0;
        let history = JSON.parse(localStorage.getItem("workoutHistory")) || [];
        let charts = {};

        function renderTable() {
            const day = days[currentDayIndex];
            const tableHead = document.getElementById("tableHead");
            const tableBody = document.getElementById("tableBody");
            const dayDisplay = document.getElementById("dayDisplay");
            const sessionType = document.getElementById("sessionType");
            const dayToggle = document.getElementById("dayToggle");
            const sessionDetails = document.getElementById("sessionDetails");

            console.log("Rendering table for", day.label);
            console.log("Elements:", { dayDisplay, sessionType, dayToggle, sessionDetails });

            if (!dayDisplay || !sessionType || !dayToggle || !sessionDetails) {
                console.error("One or more elements are null:", {
                    dayDisplay: !!dayDisplay,
                    sessionType: !!sessionType,
                    dayToggle: !!dayToggle,
                    sessionDetails: !!sessionDetails
                });
                alert("Error: Page elements not found. Please check the HTML structure.");
                return;
            }

            dayDisplay.textContent = currentDayIndex + 1;
            sessionType.textContent = day.label.split(" - ")[1];
            dayToggle.textContent = currentDayIndex + 2 > days.length ? "1" : currentDayIndex + 2;

            if (day.type === "strength") {
                tableHead.innerHTML = "<tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight (kg)</th><th>Pain (0-10)</th></tr>";
                tableBody.innerHTML = "";
                sessionDetails.innerHTML = "";
                day.exercises.forEach((ex, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${ex.name}</td>
                        <td>${ex.sets}</td>
                        <td><input type="number" id="reps_${index}" min="0" required></td>
                        <td><input type="number" id="weight_${index}" value="${ex.weight}" ${ex.type === "bodyweight" || ex.type === "core" ? "disabled" : ""} step="0.5"></td>
                        <td><input type="number" id="pain_${index}" min="0" max="10" required></td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableHead.innerHTML = "<tr><th>Exercise</th><th>Duration (min)</th><th>Type</th><th>RPE (0-10)</th></tr>";
                tableBody.innerHTML = "";
                day.exercises.forEach((ex, index) => {
                    const row = document.createElement("tr");
                    const typeInput = ex.sessionType === "Select" ?
                        `<select id="type_${index}" onchange="updateSessionDetails()">
                            <option value="HIIT">HIIT</option>
                            <option value="Steady-State">Steady-State</option>
                        </select>` :
                        `<span>${ex.sessionType}</span>`;
                    row.innerHTML = `
                        <td>${ex.name}</td>
                        <td><input type="number" id="duration_${index}" min="0" required></td>
                        <td>${typeInput}</td>
                        <td><input type="number" id="rpe_${index}" min="0" max="10" required></td>
                    `;
                    tableBody.appendChild(row);
                });
                updateSessionDetails();
            }
            renderHistory();
            renderCharts();
        }

        function updateSessionDetails() {
            const day = days[currentDayIndex];
            const sessionDetails = document.getElementById("sessionDetails");
            if (!sessionDetails) return;

            if (day.type !== "bike") {
                sessionDetails.innerHTML = "";
                return;
            }

            if (day.sessionType === "Select") {
                const sessionType = document.getElementById("type_0")?.value || "HIIT";
                sessionDetails.innerHTML = day.details[sessionType];
            } else {
                sessionDetails.innerHTML = day.details;
            }
        }

        function toggleDay() {
            currentDayIndex = (currentDayIndex + 1) % days.length;
            renderTable();
        }

        function getSuggestion(exercise, repsOrDuration, weightOrType, painOrRpe, prevSessions, dayType) {
            const prevSameExercise = prevSessions.filter(s => s.exercise === exercise.name && s.day === days[currentDayIndex].label).slice(-2);
            if (dayType === "strength") {
                if (painOrRpe >= 5) {
                    return `High pain (${painOrRpe}/10). Reduce weight by 10% or switch to ${exercise.type === "barbell" ? "dumbbell variation" : "lower intensity"}. Consult physio if persistent.`;
                }
                if (prevSameExercise.length >= 2 && prevSameExercise.every(s => s.reps >= exercise.maxReps && s.pain < 5)) {
                    if (exercise.type === "barbell") return `Hit ${exercise.maxReps} reps consistently. Increase weight by 2.5–5kg.`;
                    if (exercise.type === "dumbbell") return `Hit ${exercise.maxReps} reps consistently. Increase weight by 1–2kg or add 1–2 reps.`;
                    if (exercise.type === "bodyweight") return `Hit ${exercise.maxReps} reps. Add 1 rep or reduce assistance (e.g., lighter band).`;
                    if (exercise.type === "cable") return `Hit ${exercise.maxReps} reps. Increase weight slightly or add 1–3 reps.`;
                    if (exercise.type === "core") return `Hit ${exercise.maxReps} ${exercise.unit || "reps"}. Increase by 5–10s or 2–3 reps.`;
                }
                return "Maintain current weight/reps. Focus on form.";
            } else {
                if (painOrRpe >= 8) {
                    return `High RPE (${painOrRpe}/10). Reduce intensity or duration next session.`;
                }
                if (repsOrDuration >= exercise.maxDuration && painOrRpe < 8) {
                    return `Hit ${exercise.maxDuration} min. Increase duration by 5 min or intensity slightly.`;
                }
                return "Maintain current duration/intensity. Focus on consistency.";
            }
        }

        function renderHistory() {
            const historyBody = document.getElementById("historyBody");
            if (!historyBody) {
                console.error("historyBody element not found");
                return;
            }
            historyBody.innerHTML = "";
            history.forEach(session => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${session.date}</td>
                    <td>${session.day}</td>
                    <td>${session.exercise}</td>
                    <td>${session.sets}</td>
                    <td>${session.repsOrDuration}</td>
                    <td>${session.weightOrType}</td>
                    <td>${session.painOrRpe}</td>
                    <td class="${session.painOrRpe >= (session.day.includes("Bike") ? 8 : 5) ? "alert" : "suggestion"}">${session.suggestion}</td>
                `;
                historyBody.appendChild(row);
            });
        }

        function renderCharts() {
            const chartsContainer = document.getElementById("chartsContainer");
            if (!chartsContainer) {
                console.error("chartsContainer element not found");
                return;
            }
            chartsContainer.innerHTML = "";
            Object.keys(charts).forEach(key => charts[key]?.destroy());

            days.forEach(day => {
                const dayHeader = document.createElement("h3");
                dayHeader.textContent = day.label;
                chartsContainer.appendChild(dayHeader);

                day.exercises.forEach(ex => {
                    const canvas = document.createElement("canvas");
                    canvas.id = `chart_${ex.name.replace(/\s+/g, "_")}_${day.name}`;
                    canvas.className = "chart-container";
                    chartsContainer.appendChild(canvas);

                    const sessions = history.filter(s => s.exercise === ex.name && s.day === day.label).slice(-10);
                    const labels = sessions.map(s => s.date);
                    const repsOrDurationData = sessions.map(s => s.repsOrDuration);
                    const weightOrTypeData = sessions.map(s => s.day.includes("Bike") ? (s.weightOrType === "HIIT" ? 1 : 0) : s.weightOrType);
                    const painOrRpeData = sessions.map(s => s.painOrRpe);

                    try {
                        charts[canvas.id] = new Chart(canvas, {
                            type: "line",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: day.type === "bike" ? "Duration (min)" : "Reps",
                                        data: repsOrDurationData,
                                        borderColor: "#0288d1",
                                        backgroundColor: "#0288D1",
                                        yAxisID: "y",
                                        fill: false
                                    },
                                    {
                                        label: day.type === "bike" ? "Session Type (HIIT=1, Steady=0)" : "Weight (kg)",
                                        data: weightOrTypeData,
                                        borderColor: "#388e3c",
                                        backgroundColor: "#388e3c",
                                        yAxisID: "y1",
                                        fill: false,
                                        hidden: ex.type === "bodyweight" || ex.type === "core"
                                    },
                                    {
                                        label: day.type === "bike" ? "RPE (0-10)" : "Pain (0-10)",
                                        data: painOrRpeData,
                                        borderColor: "#d32f2f",
                                        backgroundColor: "#d32f2f",
                                        yAxisID: "y",
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { title: { display: true, text: "Date" } },
                                    y: {
                                        type: "linear",
                                        display: true,
                                        position: "left",
                                        title: { display: true, text: day.type === "bike" ? "Duration (min)/RPE" : (ex.unit === "seconds" ? "Seconds/Reps" : "Reps/Pain") },
                                        suggestedMin: 0,
                                        suggestedMax: Math.max(day.type === "bike" ? 50 : 15, ...repsOrDurationData, ...painOrRpeData) + 5
                                    },
                                    y1: {
                                        type: "linear",
                                        display: ex.type !== "bodyweight" && ex.type !== "core",
                                        position: "right",
                                        title: { display: true, text: day.type === "bike" ? "Session Type (HIIT=1, Steady=0)" : "Weight (kg)" },
                                        suggestedMin: day.type === "bike" ? 0 : 0,
                                        suggestedMax: day.type === "bike" ? 1 : Math.max(...weightOrTypeData, ex.weight || 0) + 10,
                                        grid: { drawOnChartArea: false }
                                    }
                                },
                                plugins: { title: { display: true, text: `${ex.name} Progress` } }
                            }
                        });
                    } catch (e) {
                        console.error("Chart rendering failed:", e);
                    }
                });
            });
        }

        document.getElementById("workoutForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const date = new Date().toLocaleDateString();
            const day = days[currentDayIndex];
            day.exercises.forEach((ex, index) => {
                if (day.type === "strength") {
                    const reps = parseInt(document.getElementById(`reps_${index}`)?.value || 0);
                    const weight = ex.type === "bodyweight" || ex.type === "core" ? ex.weight : parseFloat(document.getElementById(`weight_${index}`)?.value || ex.weight);
                    const pain = parseInt(document.getElementById(`pain_${index}`)?.value || 0);
                    const suggestion = getSuggestion(ex, reps, weight, pain, history, "strength");
                    history.push({
                        date,
                        day: day.label,
                        exercise: ex.name,
                        sets: ex.sets,
                        repsOrDuration: reps,
                        weightOrType: weight,
                        painOrRpe: pain,
                        suggestion
                    });
                } else {
                    const duration = parseInt(document.getElementById(`duration_${index}`)?.value || 0);
                    const type = ex.sessionType === "Select" ? document.getElementById(`type_${index}`)?.value : ex.sessionType;
                    const rpe = parseInt(document.getElementById(`rpe_${index}`)?.value || 0);
                    const suggestion = getSuggestion(ex, duration, type, rpe, history, "bike");
                    history.push({
                        date,
                        day: day.label,
                        exercise: ex.name,
                        sets: ex.sets,
                        repsOrDuration: duration,
                        weightOrType: type,
                        painOrRpe: rpe,
                        suggestion
                    });
                }
            });
            localStorage.setItem("workoutHistory", JSON.stringify(history));
            renderHistory();
            renderCharts();
            document.getElementById("workoutForm")?.reset();
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/sw.js", { scope: "/" }).then(registration => {
                console.log("Service Worker registered successfully with scope:", registration.scope);
            }).catch(err => {
                console.error("Service Worker registration failed:", err.message, err);
                alert("Service Worker registration failed. Offline mode may not work. Check console for details.");
            });
        } else {
            console.warn("Service Worker not supported in this browser");
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM loaded, rendering table...");
            renderTable();
        });
    </script>
</body>
</html>